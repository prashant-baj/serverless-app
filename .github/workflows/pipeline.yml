name: Mono-Repo DevSecOps Pipeline

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'serverless-labs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'serverless-labs/**'

permissions:
  id-token: write
  contents: read
  security-events: write

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  PYTHON_VERSION: "3.12"

jobs:

# ─────────────────────────────────────────────────────────────
# JOB 0 — DETECT CHANGES
# ─────────────────────────────────────────────────────────────
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      ai-doc-processor: ${{ steps.filter.outputs.ai-doc-processor }}
      invoice-notifier: ${{ steps.filter.outputs.invoice-notifier }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            ai-doc-processor:
              - 'services/ai-doc-processor/**'
              - 'shared/**'
            invoice-notifier:
              - 'services/invoice-notifier/**'
              - 'shared/**'


# ─────────────────────────────────────────────────────────────
# JOB 1 — SECURITY (DEMO SAFE)
# ─────────────────────────────────────────────────────────────
  security:
    name: DevSecOps Security Scans (Demo Safe)
    runs-on: ubuntu-latest
    needs: [detect-changes]

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      # ---------- Install scanners ----------
      - name: Install security tools
        run: |
          pip install bandit bandit-sarif-formatter pip-audit

      # ---------- Create empty SARIF placeholders ----------
      - name: Initialise SARIF placeholders
        run: |
          EMPTY='{"version":"2.1.0","runs":[]}'
          echo "$EMPTY" > bandit.sarif
          echo "$EMPTY" > trivy.sarif

      # ---------- Python SAST ----------
      - name: Bandit scan
        run: bandit -r . -f sarif -o bandit.sarif --exit-zero || true

      - name: Upload Bandit results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: bandit.sarif

      # ---------- Dependency CVE Scan ----------
      - name: Dependency vulnerability scan
        run: |
          if [ -f shared/requirements.txt ]; then
            pip-audit -r shared/requirements.txt || true
          else
            echo "No shared requirements.txt found — skipping pip-audit"
          fi

      # ---------- Filesystem / Container ----------
      - name: Trivy vulnerability scan
        uses: aquasecurity/trivy-action@0.28.0
        continue-on-error: true
        with:
          scan-type: fs
          scan-ref: .
          format: sarif
          output: trivy.sarif
          severity: CRITICAL,HIGH
          exit-code: "0"

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: trivy.sarif


# ─────────────────────────────────────────────────────────────
# JOB 2a — TEST: ai-doc-processor
# ─────────────────────────────────────────────────────────────
  test-ai-doc-processor:
    name: Test — ai-doc-processor
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.ai-doc-processor == 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        working-directory: services/ai-doc-processor/infra
        run: |
          pip install -r requirements.txt -r requirements-dev.txt
          pip install -e ../../../shared

      - name: Run tests
        working-directory: services/ai-doc-processor/infra
        run: pytest tests/ -v


# ─────────────────────────────────────────────────────────────
# JOB 2b — TEST: invoice-notifier
# ─────────────────────────────────────────────────────────────
  test-invoice-notifier:
    name: Test — invoice-notifier
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.invoice-notifier == 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        working-directory: services/invoice-notifier/infra
        run: |
          pip install -r requirements.txt -r requirements-dev.txt
          pip install -e ../../../shared

      - name: Run tests
        working-directory: services/invoice-notifier/infra
        run: pytest tests/ -v


# ─────────────────────────────────────────────────────────────
# JOB 3 — DEPLOY ai-doc-processor
# ─────────────────────────────────────────────────────────────
  deploy-ai-doc-processor:
    name: Deploy — ai-doc-processor
    runs-on: ubuntu-latest
    needs: [detect-changes, test-ai-doc-processor, security]
    if: |
      always() &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      needs.detect-changes.outputs.ai-doc-processor == 'true' &&
      (needs.test-ai-doc-processor.result == 'success' || needs.test-ai-doc-processor.result == 'skipped') &&
      needs.security.result == 'success'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install CDK dependencies
        working-directory: services/ai-doc-processor/infra
        run: |
          pip install -r requirements.txt
          pip install -e ../../../shared

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - run: npm install -g aws-cdk

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: CDK Deploy
        working-directory: services/ai-doc-processor/infra
        run: cdk deploy AIDocProcessorStack --require-approval never