name: Mono-Repo DevSecOps Pipeline

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'serverless-labs/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'serverless-labs/**'

permissions:
  id-token: write
  contents: read
  security-events: write

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  PYTHON_VERSION: "3.12"

jobs:

# ─────────────────────────────────────────────────────────────
# JOB 0 — DETECT CHANGES
# Produces boolean outputs consumed by every downstream job.
# A change to shared/ triggers both service pipelines because
# it could affect any service stack.
# ─────────────────────────────────────────────────────────────
  detect-changes:
    name: Detect Changed Services
    runs-on: ubuntu-latest
    outputs:
      ai-doc-processor: ${{ steps.filter.outputs.ai-doc-processor }}
      invoice-notifier: ${{ steps.filter.outputs.invoice-notifier }}
    steps:
      - uses: actions/checkout@v4

      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            ai-doc-processor:
              - 'services/ai-doc-processor/**'
              - 'shared/**'
            invoice-notifier:
              - 'services/invoice-notifier/**'
              - 'shared/**'


# ─────────────────────────────────────────────────────────────
# JOB 1 — SECURITY (repo-wide, always runs)
# CodeQL, Bandit, pip-audit, Checkov, Trivy → GitHub Security.
# ─────────────────────────────────────────────────────────────
  security:
    name: DevSecOps Security Scans
    runs-on: ubuntu-latest
    needs: [detect-changes]

    steps:
      - uses: actions/checkout@v4

      # ---------- GitHub Native SAST ----------
      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: python

      - name: CodeQL Analysis
        uses: github/codeql-action/analyze@v3

      # ---------- Python SAST ----------
      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Bandit + SARIF formatter
        run: pip install bandit bandit-sarif-formatter

      - name: Bandit scan
        run: bandit -r . -f sarif -o bandit.sarif --exit-zero

      - name: Upload Bandit results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: bandit.sarif

      # ---------- Dependency CVE Scan ----------
      - name: Install pip-audit
        run: pip install pip-audit

      - name: Dependency vulnerability scan
        run: pip-audit -r shared/requirements.txt || true

      # ---------- IaC Security ----------
      - name: Checkov IaC scan
        uses: bridgecrewio/checkov-action@v12
        with:
          directory: .
          framework: cloudformation,dockerfile
          output_format: sarif
          output_file_path: checkov.sarif
          soft_fail: true

      - name: Upload Checkov results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: checkov.sarif

      # ---------- Filesystem / Container ----------
      - name: Trivy vulnerability scan
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: fs
          scan-ref: .
          format: sarif
          output: trivy.sarif
          severity: CRITICAL,HIGH
          exit-code: "0"

      - name: Upload Trivy results
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true
        with:
          sarif_file: trivy.sarif


# ─────────────────────────────────────────────────────────────
# JOB 2a — TEST: ai-doc-processor
# Runs only when services/ai-doc-processor/** or shared/** changed.
# ─────────────────────────────────────────────────────────────
  test-ai-doc-processor:
    name: Test — ai-doc-processor
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.ai-doc-processor == 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            services/ai-doc-processor/infra/requirements.txt
            services/ai-doc-processor/infra/requirements-dev.txt

      - name: Install dependencies
        working-directory: services/ai-doc-processor/infra
        run: |
          pip install -r requirements.txt -r requirements-dev.txt
          pip install -e ../../../shared

      - name: Run tests
        working-directory: services/ai-doc-processor/infra
        run: pytest tests/ -v


# ─────────────────────────────────────────────────────────────
# JOB 2b — TEST: invoice-notifier
# ─────────────────────────────────────────────────────────────
  test-invoice-notifier:
    name: Test — invoice-notifier
    runs-on: ubuntu-latest
    needs: [detect-changes]
    if: needs.detect-changes.outputs.invoice-notifier == 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            services/invoice-notifier/infra/requirements.txt
            services/invoice-notifier/infra/requirements-dev.txt

      - name: Install dependencies
        working-directory: services/invoice-notifier/infra
        run: |
          pip install -r requirements.txt -r requirements-dev.txt
          pip install -e ../../../shared

      - name: Run tests
        working-directory: services/invoice-notifier/infra
        run: pytest tests/ -v


# ─────────────────────────────────────────────────────────────
# JOB 3a — SYNTH: ai-doc-processor (PR only)
# ─────────────────────────────────────────────────────────────
  synth-ai-doc-processor:
    name: CDK Synth — ai-doc-processor
    runs-on: ubuntu-latest
    needs: [detect-changes, test-ai-doc-processor, security]
    if: |
      github.event_name == 'pull_request' &&
      needs.detect-changes.outputs.ai-doc-processor == 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install CDK dependencies
        working-directory: services/ai-doc-processor/infra
        run: |
          pip install -r requirements.txt
          pip install -e ../../../shared

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - run: npm install -g aws-cdk

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: CDK Synth
        working-directory: services/ai-doc-processor/infra
        run: cdk synth


# ─────────────────────────────────────────────────────────────
# JOB 3b — SYNTH: invoice-notifier (PR only)
# ─────────────────────────────────────────────────────────────
  synth-invoice-notifier:
    name: CDK Synth — invoice-notifier
    runs-on: ubuntu-latest
    needs: [detect-changes, test-invoice-notifier, security]
    if: |
      github.event_name == 'pull_request' &&
      needs.detect-changes.outputs.invoice-notifier == 'true'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install CDK dependencies
        working-directory: services/invoice-notifier/infra
        run: |
          pip install -r requirements.txt
          pip install -e ../../../shared

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - run: npm install -g aws-cdk

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: CDK Synth
        working-directory: services/invoice-notifier/infra
        run: cdk synth


# ─────────────────────────────────────────────────────────────
# JOB 4a — DEPLOY: ai-doc-processor (main push only)
#
# Uses always() + explicit result checks to prevent GitHub from
# auto-skipping this job when test-ai-doc-processor was skipped
# (the default behaviour when a needed job is skipped).
# ─────────────────────────────────────────────────────────────
  deploy-ai-doc-processor:
    name: Deploy — ai-doc-processor
    runs-on: ubuntu-latest
    needs: [detect-changes, test-ai-doc-processor, security]
    if: |
      always() &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      needs.detect-changes.outputs.ai-doc-processor == 'true' &&
      (needs.test-ai-doc-processor.result == 'success' || needs.test-ai-doc-processor.result == 'skipped') &&
      needs.security.result == 'success'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install CDK dependencies
        working-directory: services/ai-doc-processor/infra
        run: |
          pip install -r requirements.txt
          pip install -e ../../../shared

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - run: npm install -g aws-cdk

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - uses: docker/setup-buildx-action@v3

      - name: CDK Deploy
        working-directory: services/ai-doc-processor/infra
        env:
          CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
          CDK_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
        run: cdk deploy AIDocProcessorStack --require-approval never


# ─────────────────────────────────────────────────────────────
# JOB 4b — DEPLOY: invoice-notifier (main push only)
# ─────────────────────────────────────────────────────────────
  deploy-invoice-notifier:
    name: Deploy — invoice-notifier
    runs-on: ubuntu-latest
    needs: [detect-changes, test-invoice-notifier, security]
    if: |
      always() &&
      github.event_name == 'push' &&
      github.ref == 'refs/heads/main' &&
      needs.detect-changes.outputs.invoice-notifier == 'true' &&
      (needs.test-invoice-notifier.result == 'success' || needs.test-invoice-notifier.result == 'skipped') &&
      needs.security.result == 'success'

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install CDK dependencies
        working-directory: services/invoice-notifier/infra
        run: |
          pip install -r requirements.txt
          pip install -e ../../../shared

      - uses: actions/setup-node@v4
        with:
          node-version: "22"

      - run: npm install -g aws-cdk

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - uses: docker/setup-buildx-action@v3

      - name: CDK Deploy
        working-directory: services/invoice-notifier/infra
        env:
          CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
          CDK_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
        run: cdk deploy InvoiceNotifierStack --require-approval never
