name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Required for GitHub OIDC token (keyless AWS auth)
permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  PYTHON_VERSION: "3.12"

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # JOB 1 — TEST (runs on every PR and push to main)
  # ─────────────────────────────────────────────────────────────────────────────
  test:
    name: Unit Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: |
            infra/requirements.txt
            infra/requirements-dev.txt

      - name: Install CDK dependencies
        working-directory: infra
        run: pip install -r requirements.txt -r requirements-dev.txt

      - name: Run unit tests
        working-directory: infra
        run: pytest tests/ -v

  # ─────────────────────────────────────────────────────────────────────────────
  # JOB 2 — SYNTH (PR only — validates CDK templates without deploying)
  # ─────────────────────────────────────────────────────────────────────────────
  synth:
    name: CDK Synth (PR validation)
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'pull_request'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: infra/requirements.txt

      - name: Install CDK dependencies
        working-directory: infra
        run: pip install -r requirements.txt

      - name: Set up Node.js (for AWS CDK CLI)
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install AWS CDK CLI
        run: npm install -g aws-cdk

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: CDK Synth
        working-directory: infra
        env:
          CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
          CDK_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
        # Synthesizes CloudFormation templates and validates the Docker image build
        # without actually deploying anything to AWS.
        run: cdk synth

  # ─────────────────────────────────────────────────────────────────────────────
  # JOB 3 — DEPLOY (push to main only — builds Docker, pushes to ECR, deploys)
  # ─────────────────────────────────────────────────────────────────────────────
  deploy:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ env.PYTHON_VERSION }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip
          cache-dependency-path: infra/requirements.txt

      - name: Install CDK dependencies
        working-directory: infra
        run: pip install -r requirements.txt

      - name: Set up Node.js (for AWS CDK CLI)
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install AWS CDK CLI
        run: npm install -g aws-cdk

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_DEPLOY_ROLE_ARN }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: CDK Deploy
        working-directory: infra
        env:
          CDK_DEFAULT_ACCOUNT: ${{ secrets.AWS_ACCOUNT_ID }}
          CDK_DEFAULT_REGION: ${{ secrets.AWS_REGION }}
        # Builds the Docker image, pushes it to ECR, and deploys the
        # CloudFormation stack (AIDocProcessorStack) — all in one command.
        run: |
          cdk deploy --all \
            --require-approval never \
            --outputs-file ../cdk-outputs.json

      - name: Show stack outputs
        if: always()
        run: |
          if [ -f cdk-outputs.json ]; then
            echo "### Stack Outputs" >> $GITHUB_STEP_SUMMARY
            cat cdk-outputs.json >> $GITHUB_STEP_SUMMARY
          fi
